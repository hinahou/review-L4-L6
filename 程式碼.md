import React, { useState, useEffect } from 'react';
import { Sparkles, ShoppingBag, Home, Coins, ArrowRight, Check, X } from 'lucide-react';

// --- Ê®£ÂºèË®≠ÂÆö (Keyframes & Custom Styles) ---
const globalStyles = `
    @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');
    
    .font-zen {
        font-family: 'Zen Maru Gothic', sans-serif;
    }

    .animate-wiggle {
        animation: wiggle 2s ease-in-out infinite;
    }
    @keyframes wiggle {
        0%, 100% { transform: rotate(-3deg); }
        50% { transform: rotate(3deg); }
    }
    
    .animate-bounce-soft {
        animation: bounceSoft 2s infinite;
    }
    @keyframes bounceSoft {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .pop-in {
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .confetti-piece {
        position: absolute;
        width: 10px;
        height: 10px;
        top: -10px;
        opacity: 0;
        z-index: 50;
    }
    @keyframes confetti-fall {
        0% { opacity: 1; top: -10px; transform: translateX(0) rotate(0deg); }
        100% { opacity: 0; top: 100vh; transform: translateX(100px) rotate(720deg); }
    }
    
    .spin-slow {
        animation: spin 3s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;

// --- È°åÂ∫´Ë≥áÊñô ---
const FULL_QUESTION_BANK = [
    {
        id: 1,
        category: "ËÉåÂΩ±",
        question: "„ÄäËÉåÂΩ±„ÄãÁöÑ‰ΩúËÄÖÂõûÊÉ≥ÂæÄ‰∫ãË™™Ôºö„ÄåÂîâÔºÅÊàëÁèæÂú®ÊÉ≥ÊÉ≥ÔºåÈÇ£ÊôÇÁúüÊòØÂ§™ËÅ∞Êòé‰∫ÜÔºÅ„ÄçÁî±ÈÄôÊÆµË©±ÂèØ‰ª•ÁúãÂá∫‰ΩúËÄÖÁï∂ÊôÇÁöÑÂøÉÊÉÖÁÇ∫‰ΩïÔºü",
        options: ["Ëá™‰ø°ÊªøÊªø", "ÂæåÊÇîËá™Ë≤¨", "‰ΩéËêΩÊ∂àÊ≤â", "ÊìîÂøÉÁÑ¶ÊÄ•"],
        answer: "ÂæåÊÇîËá™Ë≤¨",
        explanation: "‰ΩúËÄÖ‰ª•„ÄåÂÄíÂèç„ÄçÊâãÊ≥ïËøΩÊÇîËá™Â∑±Áï∂Âπ¥ÁöÑÂπ¥Â∞ëÁÑ°Áü•„ÄÅËá™‰ª•ÁÇ∫ÊòØÔºå‰∏ç‰∫ÜËß£Áà∂Ë¶™ÁöÑÁî®ÂøÉÔºåË°®ÈÅîÂÖßÂøÉÁÑ°ÊØîÁöÑÊÑßÁñöËàáËá™Ë≤¨„ÄÇ"
    },
    {
        id: 2,
        category: "ÂøÉÂõö",
        question: "ÊùèÊûóÂ≠êË™çÁÇ∫‰∏ÄÂÄã‰∫∫Âè™Ë¶ÅËÉΩÁ™ÅÁ†¥ÂøÉÈùàÁöÑÊû∑ÈéñÔºåÈÄôÂÄã‰∏ñÁïåÂ∞±ÂÜç‰πüÊ≤íÊúâ‰ªÄÈ∫ºËÉΩÂõ∞Âæó‰Ωè‰ªñÁöÑ‰∫Ü„ÄÇÈÄôË°®Á§∫‰∫∫ÊáâË¶ÅÂ¶Ç‰ΩïËá™ËôïÔºü",
        options: ["ÂêçÈüÅÂà©Èéñ", "Ê®ÇÂ§©ÈÅîËßÄ", "ÁûªÂâçÈ°ßÂæå", "ÊÇ£ÂæóÊÇ£Â§±"],
        answer: "Ê®ÇÂ§©ÈÅîËßÄ",
        explanation: "ÊåáÈ†ÜÊáâËá™ÁÑ∂‰πãÁêÜÔºåÂÆâÊñºËôïÂ¢ÉÔºåÊ®ÇËßÄËÄå‰∏çÊÜÇÂÇ∑„ÄÇÂÖ∂È§òÈÅ∏È†ÖÁöÜÊúâË≤†Èù¢ÊàñÊãòÊùü‰πãÊÑè„ÄÇ"
    },
    {
        id: 3,
        category: "Ë©ûË™ûÈÅãÁî®",
        question: "„ÄåÁ¶ç‰∏çÂñÆË°å„ÄçÊòØÊåá‰∏çÂπ∏ÁöÑ‰∫ãÊé•ÈÄ£ÁôºÁîü„ÄÇ‰∏ãÂàóÂì™‰∏ÄÂÄãË©ûË™ûÁöÑÊÑèÊÄùÊúÄÊé•ËøëÔºü",
        options: ["Èõ™‰∏äÂä†Èúú", "ÊªîÂ§©Â§ßÁ¶ç", "Â¶ÇÂñ™ËÄÉÂ¶£", "‰∏çÊ∏¨‰πãÁ¶ç"],
        answer: "Èõ™‰∏äÂä†Èúú",
        explanation: "Èõ™‰∏äÂä†ÈúúÔºöÊØîÂñªÊé•ÈÄ£ÈÅ≠ÂèóÁÅΩÈõ£ÔºåÊêçÂÆ≥ÊÑàÂä†Âö¥Èáç„ÄÇÂ¶ÇÂñ™ËÄÉÂ¶£ÊòØÂΩ¢ÂÆπÊÇ≤ÁóõËá≥Ê•µ„ÄÇ"
    },
    {
        id: 4,
        category: "Ë´ñË™û",
        question: "Â≠êÊõ∞Ôºö„Äå‰ªä‰πãÂ≠ùËÄÖÔºåÊòØË¨ÇËÉΩÈ§ä„ÄÇËá≥ÊñºÁä¨È¶¨ÔºåÁöÜËÉΩÊúâÈ§ä„ÄÇ„ÄçÂ≠îÂ≠êÂ∞çÊñºÈÄôÊ®£ÁöÑ„ÄåÂ≠ù„ÄçÔºåÊúâ‰ªÄÈ∫ºÊ®£ÁöÑË©ïÂÉπÔºü",
        options: ["ÁÆó‰∏ç‰∏äÊòØÁúüÊ≠£ÁöÑÂ≠ù", "ÂÆåÂÖ®ÁÆóÊòØÂ≠ùÁöÑÊ•∑Ê®°", "ÊòØ‰∏ÄÁ®ÆÂ§ß‰∏çÂ≠ùÁöÑË°åÁÇ∫", "ËàáÁúüÊ≠£ÁöÑÂ≠ùÂæàÊé•Ëøë"],
        answer: "ÁÆó‰∏ç‰∏äÊòØÁúüÊ≠£ÁöÑÂ≠ù",
        explanation: "Â≠îÂ≠êË™çÁÇ∫Â¶ÇÊûúÂè™ÊòØÁµ¶‰∫àÁâ©Ë≥™‰∏äÁöÑÂ•âÈ§äËÄåÊ≤íÊúâ„ÄåÊï¨„ÄçÔºåÈÇ£Ë∑üÈ£ºÈ§äÁä¨È¶¨Ê≤íÊúâÂçÄÂà•ÔºåÁÆó‰∏ç‰∏äÁúüÂ≠ù„ÄÇ"
    },
    {
        id: 5,
        category: "Â≠óÈü≥Â≠óÂΩ¢",
        question: "‰∏ãÂàó„Äå„ÄÄ„Äç‰∏≠ÁöÑÂ≠óÔºå‰ΩïËÄÖËÆÄÈü≥Ê≠£Á¢∫Ôºü",
        options: ["Êâã„ÄåÈä¨„ÄçÔºö„Ñé„Ñ†", "Âö¥Âàë„ÄåÊã∑„ÄçÊâìÔºö„Ñé„Ñ†Àá", "ÈáéÈ§ê„ÄåÁÉ§„ÄçËÇâÔºö„Ñé„Ñ†Àã", "ÊâãÈä¨ËÖ≥„ÄåÈêê„ÄçÔºö„Ñå„Ñß„Ñ†Àá"],
        answer: "Âö¥Âàë„ÄåÊã∑„ÄçÊâìÔºö„Ñé„Ñ†Àá",
        explanation: "Èä¨(„Ñé„Ñ†Àã)ÔºåÁÉ§(„Ñé„Ñ†Àá)ÔºåÈêê(„Ñå„Ñß„Ñ†Àä)„ÄÇ"
    },
    {
        id: 6,
        category: "ÊàêË™û",
        question: "ÂΩ¢ÂÆπ„ÄåÁùúÂ§ßÁúºÁùõË™™‰∏çÂá∫Ë©±ÔºåÂêÉÈ©öÂèóÁ™ò„ÄçÁöÑÊ®£Â≠êÔºåÊáâ‰ΩøÁî®Âì™ÂÄãÊàêË™ûÔºü",
        options: ["ÂøÉËä±ÊÄíÊîæ", "ÊÉ±ÁæûÊàêÊÄí", "Áû†ÁõÆÁµêËàå", "Ê∑±ÊÉ°ÁóõÁµï"],
        answer: "Áû†ÁõÆÁµêËàå",
        explanation: "Áû†ÁõÆÁµêËàåÔºöÁùúÂ§ßÁúºÁùõË™™‰∏çÂá∫Ë©±„ÄÇÂøÉËä±ÊÄíÊîæÊòØÈ´òËààÔºåÊÉ±ÁæûÊàêÊÄíÊòØÁîüÊ∞£ÔºåÊ∑±ÊÉ°ÁóõÁµïÊòØÂé≠ÊÉ°„ÄÇ"
    },
    {
        id: 7,
        category: "Ë´ñË™û",
        question: "„ÄåË≠¨Â¶ÇÂπ≥Âú∞ÔºåÈõñË¶Ü‰∏ÄÁ∞£ÔºåÈÄ≤ÔºåÂêæÂæÄ‰πü„ÄÇ„ÄçÈÄôÂè•Ë©±Ë°®ÈÅîÁöÑÊó®ÊÑèËàá‰∏ãÂàó‰ΩïËÄÖÊúÄÊé•ËøëÔºü",
        options: ["Ë°åÁôæÈáåËÄÖÂçäÊñº‰πùÂçÅ", "Áéâ‰∏çÁê¢Ôºå‰∏çÊàêÂô®", "Èç•ËÄåËàç‰πãÔºåÊúΩÊú®‰∏çÊäò", "‰∏çÁ©çÁ¥∞ÊµÅÔºåÁÑ°‰ª•ÊàêÊ±üÊµ∑"],
        answer: "‰∏çÁ©çÁ¥∞ÊµÅÔºåÁÑ°‰ª•ÊàêÊ±üÊµ∑",
        explanation: "Âº∑Ë™øÊåÅÁ∫åÁ¥ØÁ©çÁöÑÈáçË¶ÅÊÄß„ÄÇ‰∏çÁ©çÁ¥∞ÊµÅÔºåÁÑ°‰ª•ÊàêÊ±üÊµ∑‰πüÊòØÂº∑Ë™øÁ©çÁ¥Ø„ÄÇ"
    },
    {
        id: 8,
        category: "ËÉåÂΩ±",
        question: "„ÄäËÉåÂΩ±„Äã‰∏ÄÊñá‰∏≠Ôºå‰ΩúËÄÖÁúãÂà∞Áà∂Ë¶™Ë≤∑Ê©òÂ≠êÁöÑËÉåÂΩ±ËÄåÊµÅÊ∑öÔºå‰∏ãÂàó‰ΩïËÄÖ„Äå‰∏çÊòØ„ÄçÊµÅÊ∑öÁöÑÂéüÂõ†Ôºü",
        options: ["ÊÑüÂèóÂà∞Áà∂Ë¶™ÁöÑ‰ªòÂá∫", "Ë¶ãÁà∂Ë¶™‰∏çÈ°ßÂÆâÂç±", "ÊÜÇÂøÉÁà∂Ë¶™ÂÖ•‰∏çÊï∑Âá∫", "ÊáäÊÇî‰∏çËÉΩÈ´îÂØüÁà∂ÊÑõ"],
        answer: "ÊÜÇÂøÉÁà∂Ë¶™ÂÖ•‰∏çÊï∑Âá∫",
        explanation: "Êñá‰∏≠Êú™ÊèêÂèäÁà∂Ë¶™Á∂ìÊøüÁãÄÊ≥ÅÂ∞éËá¥ÂÖ•‰∏çÊï∑Âá∫„ÄÇÊµÅÊ∑öÊòØÂõ†ÁÇ∫ÁúãË¶ãÁà∂Ë¶™ËÇ•ËÉñË∫´ËªÄÊîÄÁà¨ÊúàÂè∞ÁöÑËâ±ËæõÔºåÊÑüÂèóÂà∞Áà∂ÊÑõ‰∏¶ÊáäÊÇîËá™Â∑±ÈÅéÂéªÁöÑÁÑ°Áü•„ÄÇ"
    },
    {
        id: 9,
        category: "Â≠óÈü≥Â≠óÂΩ¢",
        question: "‰∏ãÂàó„Äå„ÄÄ„Äç‰∏≠ÁöÑÂΩ¢‰ººÂ≠óÔºå‰ΩïÁµÑËÆÄÈü≥Áõ∏ÂêåÔºü",
        options: ["Âõë„ÄåË®ó„ÄçÔºè„ÄåÁüö„ÄçÁõÆ", "„ÄåÊüµ„ÄçÊ¨ÑÔºè„ÄåÁèä„ÄçÁëö", "ÊÖò„ÄåÊæπ„ÄçÔºè„ÄåË¥ç„ÄçÈ§ä", "Ê£â„ÄåË¢ç„ÄçÔºè„ÄåÂà®„ÄçÂÜ∞"],
        answer: "Âõë„ÄåË®ó„ÄçÔºè„ÄåÁüö„ÄçÁõÆ",
        explanation: "ÂõëËàáÁüöÁöÜËÆÄ‰Ωú„Äå„Ñì„Ñ®Àá„Äç„ÄÇ(A)„Ñì„ÑöÀã/„Ñï„Ñ¢ (C)„Ñâ„Ñ¢Àã/„Ñï„Ñ¢Àã (D)„ÑÜ„Ñ†Àä/„ÑÖ„Ñ†Àã„ÄÇ"
    },
    {
        id: 10,
        category: "‰øÆËæ≠",
        question: "„ÄåÂîâÔºÅÊàëÁèæÂú®ÊÉ≥ÊÉ≥ÔºåÈÇ£ÊôÇÁúüÊòØÂ§™ËÅ∞Êòé‰∫ÜÔºÅ„Äç‰ΩøÁî®‰∫Ü‰ªÄÈ∫º‰øÆËæ≠ÊäÄÂ∑ßÔºü",
        options: ["Ë≠¨Âñª", "ËΩâÂåñ", "ÂÄíÂèç", "ÊéíÊØî"],
        answer: "ÂÄíÂèç",
        explanation: "ÊïÖÊÑè‰ΩøÁî®ËàáÊú¨ÊÑèÁõ∏ÂèçÁöÑË©ûË™û‰æÜË°®ÈÅîÊú¨ÊÑèÔºå‰ΩúËÄÖÂÖ∂ÂØ¶ÊòØË™™Ëá™Â∑±Áï∂ÊôÇÂæàÁ¨®„ÄÅ‰∏çÊáÇ‰∫ã„ÄÇ"
    },
    {
        id: 11,
        category: "ÂøÉÂõö",
        question: "‰ΩúËÄÖÊùèÊûóÂ≠êË™çÁÇ∫ÁúüÊ≠£ÁöÑ„ÄåÊû∑Èéñ„ÄçÊåáÁöÑÊòØ‰ªÄÈ∫ºÔºü",
        options: ["Ë∫´È´îÁöÑÊÆòÁñæ", "ÂøÉÁêÜÁöÑ‰∏çÂÅ•ÂÖ®", "Ë≤ßÁ™ÆÁöÑÁí∞Â¢É", "ÊúãÂèãÁöÑËÉåÂèõ"],
        answer: "ÂøÉÁêÜÁöÑ‰∏çÂÅ•ÂÖ®",
        explanation: "‰ΩúËÄÖË™çÁÇ∫Ë∫´Âõö‰∏çÊòØÁúüÂõöÔºåÂøÉÈùàÁöÑÊû∑ÈéñÔºàÂ¶ÇÊÇ≤ËßÄ„ÄÅÊÜ§ÊÄí„ÄÅÂêçÂà©ÊùüÁ∏õÔºâÊâçÊòØÁúüÊ≠£ÁöÑÂõöÁ¶Å„ÄÇ"
    },
    {
        id: 12,
        category: "Ë´ñË™û",
        question: "ÊõæÂ≠êÊõ∞Ôºö„ÄåÂêæÊó•‰∏âÁúÅÂêæË∫´„ÄÇ„ÄçÈÄôÂè•Ë©±ÁöÑ‰∏ªÊó®ÁÇ∫‰ΩïÔºü",
        options: ["Â≠∏Áøí‰∏çÂèØÂçäÈÄîËÄåÂª¢", "ÊïòËø∞Ëá™ÊàëÂèçÁúÅÁöÑÈù¢Âêë", "ÊèêÈÜíÊôÇ‰∫∫ÂèäÊôÇË°åÂ≠ù", "‰ª•Ë≥¢Âæ∑‰πã‰∫∫ÁÇ∫Ê®°ÁØÑ"],
        answer: "ÊïòËø∞Ëá™ÊàëÂèçÁúÅÁöÑÈù¢Âêë",
        explanation: "ÊõæÂ≠êÈÄèÈÅéÊØèÊó•Â§öÊ¨°ÂèçÁúÅÔºàÁÇ∫‰∫∫Ë¨ÄËÄå‰∏çÂø†‰πéÔºüËàáÊúãÂèã‰∫§ËÄå‰∏ç‰ø°‰πéÔºüÂÇ≥‰∏çÁøí‰πéÔºüÔºâÔºå‰æÜÊèêÂçáËá™Êàë‰øÆÈ§ä„ÄÇ"
    }
];

// --- ÂêâÁ••Áâ© SVG ÂÖÉ‰ª∂ (‰∏ÄËà¨ÂèØÊÑõÂãïÁâ©Áâà) ---

// 1. Â∞èÁÜä (Bear) - ÂúìÊΩ§Ê∫´Êöñ
const MascotBear = ({ emotion }) => (
    <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-md">
        {/* Ears */}
        <circle cx="50" cy="50" r="25" fill="#d97706" stroke="#78350f" strokeWidth="4" />
        <circle cx="150" cy="50" r="25" fill="#d97706" stroke="#78350f" strokeWidth="4" />
        
        {/* Head */}
        <circle cx="100" cy="100" r="70" fill="#f59e0b" stroke="#78350f" strokeWidth="4" />
        
        {/* Inner Ears */}
        <circle cx="50" cy="50" r="12" fill="#fcd34d" opacity="0.8" />
        <circle cx="150" cy="50" r="12" fill="#fcd34d" opacity="0.8" />

        {/* Snout Area */}
        <ellipse cx="100" cy="115" rx="25" ry="18" fill="#fef3c7" />
        <circle cx="100" cy="110" r="8" fill="#451a03" /> {/* Nose */}

        {/* Eyes */}
        <circle cx="75" cy="90" r="6" fill="#451a03" />
        <circle cx="125" cy="90" r="6" fill="#451a03" />

        {/* Blush */}
        <ellipse cx="60" cy="115" rx="8" ry="5" fill="#fda4af" opacity="0.6" />
        <ellipse cx="140" cy="115" rx="8" ry="5" fill="#fda4af" opacity="0.6" />

        {/* Mouth */}
        {emotion === 'happy' && (
             <path d="M90 125 Q100 135 110 125" fill="none" stroke="#451a03" strokeWidth="3" strokeLinecap="round" />
        )}
        {emotion === 'sad' && (
             <path d="M90 130 Q100 120 110 130" fill="none" stroke="#451a03" strokeWidth="3" strokeLinecap="round" />
        )}
        {emotion === 'neutral' && (
             <path d="M90 128 L110 128" fill="none" stroke="#451a03" strokeWidth="3" strokeLinecap="round" />
        )}
    </svg>
);

// 2. Â∞èË≤ì (Cat) - ÁÅ∞Ëâ≤ËÅ∞Êòé
const MascotCat = ({ emotion }) => (
    <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-md">
        {/* Ears (Pointy) */}
        <path d="M40 30 L60 90 L10 80 Z" fill="#94a3b8" stroke="#334155" strokeWidth="4" strokeLinejoin="round" />
        <path d="M160 30 L190 80 L140 90 Z" fill="#94a3b8" stroke="#334155" strokeWidth="4" strokeLinejoin="round" />
        
        {/* Head */}
        <ellipse cx="100" cy="110" rx="75" ry="65" fill="#cbd5e1" stroke="#334155" strokeWidth="4" />
        
        {/* Face Features */}
        <circle cx="70" cy="100" r="6" fill="#1e293b" />
        <circle cx="130" cy="100" r="6" fill="#1e293b" />
        
        {/* Nose */}
        <path d="M95 115 L105 115 L100 122 Z" fill="#pink" stroke="#334155" strokeWidth="2" fillOpacity="0.5" />
        
        {/* Whiskers */}
        <path d="M40 105 L60 110" fill="none" stroke="#334155" strokeWidth="2" />
        <path d="M40 115 L60 115" fill="none" stroke="#334155" strokeWidth="2" />
        <path d="M160 105 L140 110" fill="none" stroke="#334155" strokeWidth="2" />
        <path d="M160 115 L140 115" fill="none" stroke="#334155" strokeWidth="2" />

        {/* Mouth */}
        {emotion === 'happy' ? (
            <path d="M90 122 Q95 128 100 122 Q105 128 110 122" fill="none" stroke="#334155" strokeWidth="3" strokeLinecap="round" />
        ) : emotion === 'sad' ? (
            <path d="M92 128 Q100 120 108 128" fill="none" stroke="#334155" strokeWidth="3" strokeLinecap="round" />
        ) : (
            <path d="M95 125 L105 125" fill="none" stroke="#334155" strokeWidth="3" strokeLinecap="round" />
        )}
    </svg>
);

// 3. Â∞èÂÖî (Rabbit) - Á≤âËâ≤Ê¥ªÂäõ
const MascotRabbit = ({ emotion }) => (
    <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-md">
        {/* Ears (Long) */}
        <ellipse cx="70" cy="60" rx="15" ry="45" fill="#fbcfe8" stroke="#be185d" strokeWidth="4" transform="rotate(-10 70 60)" />
        <ellipse cx="130" cy="60" rx="15" ry="45" fill="#fbcfe8" stroke="#be185d" strokeWidth="4" transform="rotate(10 130 60)" />
        
        {/* Head */}
        <circle cx="100" cy="110" r="65" fill="#fce7f3" stroke="#be185d" strokeWidth="4" />
        
        {/* Eyes */}
        <circle cx="75" cy="100" r="5" fill="#831843" />
        <circle cx="125" cy="100" r="5" fill="#831843" />
        
        {/* Blush */}
        <ellipse cx="60" cy="115" rx="8" ry="5" fill="#fda4af" opacity="0.6" />
        <ellipse cx="140" cy="115" rx="8" ry="5" fill="#fda4af" opacity="0.6" />
        
        {/* Nose Y shape */}
        <path d="M95 110 L105 110 L100 116 Z" fill="#db2777" stroke="none" />
        <path d="M100 116 L100 122" fill="none" stroke="#be185d" strokeWidth="2" />

        {/* Mouth */}
        {emotion === 'happy' ? (
             <path d="M92 122 Q100 128 108 122" fill="none" stroke="#be185d" strokeWidth="3" strokeLinecap="round" />
        ) : (
             <path d="M95 125 L105 125" fill="none" stroke="#be185d" strokeWidth="3" strokeLinecap="round" />
        )}
    </svg>
);

// --- ÁçéÂãµË≥áÊñô ---
const REWARDS = [
    { id: 'r1', name: 'ÈñãÂøÉÂ∞èÁÜä', cost: 50, icon: <MascotBear emotion="happy" />, desc: "Ê∫´Êöñ‰Ω†ÁöÑÂøÉ" },
    { id: 'r2', name: 'ËÅ∞ÊòéÂ∞èË≤ì', cost: 100, icon: <MascotCat emotion="neutral" />, desc: "ËÄÉË©¶ÈÉΩËÄÉ‰∏ÄÁôæÂàÜ" },
    { id: 'r3', name: 'Ê¥ªÂäõÂ∞èÂÖî', cost: 150, icon: <MascotRabbit emotion="happy" />, desc: "Ëπ¶Ëπ¶Ë∑≥Ë∑≥ÁúüÂèØÊÑõ" },
    { id: 'r4', name: 'ÊÆµËÄÉÊªøÂàÜÁ¨¶', cost: 300, icon: <div className="text-4xl text-center leading-[48px]">üíØ</div>, desc: "ËÄÉË©¶ÈÅãÊ∞£+100" },
];

export default function App() {
    const [screen, setScreen] = useState('home'); // home, quiz, result, shop
    const [points, setPoints] = useState(0);
    const [inventory, setInventory] = useState([]);
    
    // Ê®°Êì¨ LocalStorage
    useEffect(() => {
        const savedPoints = localStorage.getItem('animal_study_points');
        if (savedPoints) setPoints(parseInt(savedPoints));
        
        const savedInv = localStorage.getItem('animal_study_inventory');
        if (savedInv) setInventory(JSON.parse(savedInv));
    }, []);

    useEffect(() => {
        localStorage.setItem('animal_study_points', points);
    }, [points]);

    useEffect(() => {
        localStorage.setItem('animal_study_inventory', JSON.stringify(inventory));
    }, [inventory]);

    const [currentQuestions, setCurrentQuestions] = useState([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    const [score, setScore] = useState(0);
    const [showExplanation, setShowExplanation] = useState(false);
    const [lastAnswerCorrect, setLastAnswerCorrect] = useState(false);
    const [selectedOption, setSelectedOption] = useState(null);

    const startQuiz = () => {
        // Shuffle and pick 5
        const shuffled = [...FULL_QUESTION_BANK].sort(() => 0.5 - Math.random());
        setCurrentQuestions(shuffled.slice(0, 5));
        setCurrentIndex(0);
        setScore(0);
        setShowExplanation(false);
        setSelectedOption(null);
        setScreen('quiz');
    };

    const handleAnswer = (option) => {
        if (showExplanation) return;
        
        setSelectedOption(option);
        const currentQ = currentQuestions[currentIndex];
        const isCorrect = option === currentQ.answer;
        
        setLastAnswerCorrect(isCorrect);
        if (isCorrect) {
            setScore(s => s + 20); // ÊØèÈ°å20ÂàÜ
            triggerConfetti();
        }
        
        setShowExplanation(true);
    };

    const nextQuestion = () => {
        if (currentIndex < 4) {
            setCurrentIndex(prev => prev + 1);
            setShowExplanation(false);
            setSelectedOption(null);
        } else {
            // Quiz finished
            const earnedPoints = Math.floor(score / 2); // ÂàÜÊï∏ÁöÑ‰∏ÄÂçäËΩâÁÇ∫PÂπ£
            setPoints(p => p + earnedPoints);
            setScreen('result');
        }
    };

    const buyReward = (item) => {
        if (points >= item.cost && !inventory.includes(item.id)) {
            setPoints(p => p - item.cost);
            setInventory([...inventory, item.id]);
        }
    };

    const triggerConfetti = () => {
        const container = document.getElementById('confetti-container');
        if(!container) return;
        
        for(let i=0; i<30; i++) {
            const el = document.createElement('div');
            el.classList.add('confetti-piece');
            el.style.left = Math.random() * 100 + 'vw';
            el.style.backgroundColor = ['#FFC0CB', '#87CEEB', '#FFFFE0', '#98FB98'][Math.floor(Math.random()*4)];
            el.style.animation = `confetti-fall ${1 + Math.random()}s linear forwards`;
            container.appendChild(el);
            setTimeout(() => {
                if(el && el.parentNode) el.parentNode.removeChild(el);
            }, 2000);
        }
    };

    return (
        <div className="min-h-screen bg-orange-50 text-slate-700 font-zen overflow-hidden relative selection:bg-orange-200">
            <style>{globalStyles}</style>

            {/* Background Pattern */}
            <div className="absolute inset-0 opacity-10 pointer-events-none" style={{
                backgroundImage: `url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.4' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E")`
            }}></div>

            {screen === 'home' && (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white/90 backdrop-blur-sm p-8 rounded-[3rem] shadow-xl border-4 border-orange-200 text-center pop-in relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-4 bg-orange-300"></div>
                        
                        <div className="flex justify-center mb-6">
                            <div className="w-32 h-32 animate-wiggle">
                                <MascotBear emotion="happy" />
                            </div>
                            <div className="w-24 h-24 -ml-4 mt-8 animate-bounce-soft delay-100">
                                <MascotRabbit emotion="neutral" />
                            </div>
                        </div>

                        <h1 className="text-3xl font-bold text-slate-700 mb-2">Âúã‰∏ÄÂúãÊñá<br/>‰∫åÊÆµÂ§ßÊåëÊà∞</h1>
                        <p className="text-orange-500 font-bold mb-6">ÔΩû ‰∏ÄËµ∑Âä™ÂäõÂêß ÔΩû</p>

                        <div className="bg-yellow-100 rounded-full py-2 px-4 mb-8 inline-block border-2 border-yellow-300 shadow-sm">
                            <div className="flex items-center gap-2">
                                <Coins className="text-yellow-600 w-5 h-5" />
                                <span className="font-bold text-yellow-800">{points} PÂπ£</span>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <button 
                                onClick={startQuiz}
                                className="w-full bg-orange-400 hover:bg-orange-500 text-white font-bold py-4 px-6 rounded-2xl shadow-[0_4px_0_rgb(194,65,12)] active:shadow-none active:translate-y-1 transition-all text-xl flex items-center justify-center gap-2"
                            >
                                <Sparkles className="w-6 h-6" />
                                ÈñãÂßãÁ∑¥Áøí (5È°å)
                            </button>
                            <button 
                                onClick={() => setScreen('shop')}
                                className="w-full bg-sky-300 hover:bg-sky-400 text-white font-bold py-3 px-6 rounded-2xl shadow-[0_4px_0_rgb(14,165,233)] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-2"
                            >
                                <ShoppingBag className="w-5 h-5" />
                                ÂÖåÊèõÁçéÂãµ
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {screen === 'quiz' && (
                <div className="min-h-screen flex flex-col p-4 relative overflow-hidden">
                    <div id="confetti-container" className="absolute inset-0 pointer-events-none z-50"></div>
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 max-w-2xl mx-auto w-full pt-4">
                        <div className="bg-white rounded-full px-4 py-2 border-2 border-slate-200 text-slate-600 font-bold shadow-sm">
                            Q {currentIndex + 1} / 5
                        </div>
                        <div className="bg-orange-100 rounded-full px-4 py-2 border-2 border-orange-200 text-orange-600 font-bold shadow-sm">
                            ÂàÜÊï∏: {score}
                        </div>
                    </div>

                    {/* Question Card */}
                    <div className="flex-1 w-full max-w-2xl mx-auto flex flex-col pb-32">
                        {currentQuestions[currentIndex] && (
                            <>
                                <div className="bg-white p-6 md:p-8 rounded-[2rem] shadow-lg border-2 border-slate-100 mb-6 relative pop-in">
                                    <span className="absolute -top-3 left-6 bg-sky-200 text-sky-800 text-xs px-3 py-1 rounded-full font-bold shadow-sm">
                                        {currentQuestions[currentIndex].category}
                                    </span>
                                    <h2 className="text-xl md:text-2xl font-bold text-slate-700 leading-relaxed mt-2">
                                        {currentQuestions[currentIndex].question}
                                    </h2>
                                </div>

                                {/* Options */}
                                <div className="space-y-3">
                                    {currentQuestions[currentIndex].options.map((opt, idx) => {
                                        let btnClass = "w-full p-4 rounded-xl text-left font-medium transition-all transform active:scale-[0.98] border-2 flex items-center gap-3 ";
                                        if (selectedOption === null) {
                                            btnClass += "bg-white border-slate-200 hover:border-orange-300 hover:bg-orange-50 text-slate-600 shadow-sm";
                                        } else if (opt === currentQuestions[currentIndex].answer) {
                                            btnClass += "bg-green-100 border-green-400 text-green-800 shadow-md";
                                        } else if (selectedOption === opt) {
                                            btnClass += "bg-red-100 border-red-400 text-red-800 opacity-60";
                                        } else {
                                            btnClass += "bg-slate-50 border-slate-100 text-slate-400";
                                        }

                                        return (
                                            <button 
                                                key={idx}
                                                onClick={() => handleAnswer(opt)}
                                                disabled={selectedOption !== null}
                                                className={btnClass}
                                            >
                                                <span className={`flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm font-bold ${
                                                    selectedOption === null ? 'bg-white border-slate-300 text-slate-400' :
                                                    opt === currentQuestions[currentIndex].answer ? 'bg-green-500 border-green-500 text-white' :
                                                    selectedOption === opt ? 'bg-red-500 border-red-500 text-white' :
                                                    'bg-slate-100 border-slate-200 text-slate-300'
                                                }`}>
                                                    {['A', 'B', 'C', 'D'][idx]}
                                                </span>
                                                <span className="leading-snug">{opt}</span>
                                                {selectedOption !== null && opt === currentQuestions[currentIndex].answer && (
                                                    <Check className="ml-auto text-green-600 w-6 h-6" />
                                                )}
                                                {selectedOption === opt && opt !== currentQuestions[currentIndex].answer && (
                                                    <X className="ml-auto text-red-600 w-6 h-6" />
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </>
                        )}
                    </div>

                    {/* Explanation Modal */}
                    {showExplanation && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.15)] p-6 z-40 border-t-4 border-orange-200 max-w-2xl mx-auto pop-in">
                            <div className="flex items-start gap-4 mb-6">
                                <div className="w-20 h-20 shrink-0">
                                    {lastAnswerCorrect ? 
                                        <MascotBear emotion="happy" /> : 
                                        <MascotCat emotion="sad" />
                                    }
                                </div>
                                <div className="flex-1">
                                    <h3 className={`text-xl font-bold mb-2 flex items-center gap-2 ${lastAnswerCorrect ? 'text-green-500' : 'text-red-500'}`}>
                                        {lastAnswerCorrect ? <><Check className="w-6 h-6"/> Á≠îÂ∞ç‰∫ÜÔºÅÂ•ΩÊ£íÔºÅ</> : <><X className="w-6 h-6"/> ÂìéÂëÄÔºÅÂä†Ê≤πÔºÅ</>}
                                    </h3>
                                    <div className="text-sm text-slate-600 bg-slate-50 p-4 rounded-xl border border-slate-100 leading-relaxed">
                                        <span className="font-bold block mb-1 text-slate-800 text-base">üìù Ëß£ÊûêÔºö</span>
                                        {currentQuestions[currentIndex].explanation}
                                    </div>
                                </div>
                            </div>
                            <button 
                                onClick={nextQuestion}
                                className="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold py-4 rounded-xl shadow-[0_4px_0_rgb(14,165,233)] active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2 text-lg"
                            >
                                {currentIndex < 4 ? '‰∏ã‰∏ÄÈ°å' : 'ÁúãÊàêÁ∏æ'} <ArrowRight className="w-6 h-6" />
                            </button>
                        </div>
                    )}
                </div>
            )}

            {screen === 'result' && (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-[3rem] shadow-xl text-center pop-in border-4 border-sky-200 relative">
                        {/* Confetti decoration */}
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-12 bg-sky-200 rounded-b-full opacity-50 blur-xl"></div>

                        <div className="w-48 h-48 mx-auto mb-6 relative">
                            {score === 100 ? (
                                <>
                                    <div className="absolute inset-0 spin-slow opacity-50">
                                        <svg viewBox="0 0 100 100" className="w-full h-full">
                                            <path d="M50 0 L60 40 L100 50 L60 60 L50 100 L40 60 L0 50 L40 40 Z" fill="#fde047" />
                                        </svg>
                                    </div>
                                    <div className="relative z-10 w-full h-full animate-bounce-soft">
                                        <MascotRabbit emotion="happy"/>
                                    </div>
                                    <div className="absolute -top-4 -right-4 text-5xl animate-bounce delay-75">‚ú®</div>
                                </>
                            ) : score >= 60 ? (
                                <MascotBear emotion="happy"/>
                            ) : (
                                <MascotCat emotion="sad"/>
                            )}
                        </div>
                        
                        <h2 className="text-2xl font-bold text-slate-700 mb-2">Ê∏¨È©óÁµêÊùüÔºÅ</h2>
                        <div className="text-6xl font-black text-sky-500 mb-6 tracking-tight">{score}<span className="text-2xl text-slate-400 font-bold ml-1">ÂàÜ</span></div>
                        
                        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-4 mb-8 flex flex-col items-center">
                            <p className="text-yellow-700 font-bold text-sm uppercase tracking-wide">Áç≤ÂæóÁçéÂãµ</p>
                            <div className="flex items-center justify-center gap-2 text-3xl font-black text-yellow-500 mt-1">
                                <Coins className="w-8 h-8 fill-yellow-500" /> +{Math.floor(score / 2)}
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <button 
                                onClick={startQuiz}
                                className="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 px-4 rounded-2xl transition-all flex items-center justify-center gap-2"
                            >
                                <Sparkles className="w-5 h-5" />
                                ÂÜçÁé©‰∏ÄÊ¨°
                            </button>
                            <button 
                                onClick={() => setScreen('shop')}
                                className="bg-orange-400 hover:bg-orange-500 text-white font-bold py-4 px-4 rounded-2xl shadow-[0_4px_0_rgb(194,65,12)] active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2"
                            >
                                <ShoppingBag className="w-5 h-5" />
                                ÂéªÊèõÁ¶ÆÁâ©
                            </button>
                        </div>
                         <button 
                            onClick={() => setScreen('home')}
                            className="mt-6 text-slate-400 hover:text-slate-600 text-sm font-bold flex items-center justify-center gap-1 mx-auto py-2"
                        >
                            <Home className="w-4 h-4" /> ÂõûÈ¶ñÈ†Å
                        </button>
                    </div>
                </div>
            )}

            {screen === 'shop' && (
                <div className="min-h-screen p-4 bg-yellow-50">
                    <div className="max-w-md mx-auto">
                        <div className="flex justify-between items-center mb-6 sticky top-2 z-10">
                            <button onClick={() => setScreen('home')} className="bg-white w-12 h-12 rounded-full shadow-md border-2 border-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-50 transition-colors">
                                <Home className="w-6 h-6" />
                            </button>
                            <div className="bg-white px-5 py-2.5 rounded-full shadow-md border-2 border-yellow-200 font-bold text-yellow-700 flex items-center gap-2">
                                <Coins className="w-5 h-5 fill-yellow-400 text-yellow-600" />
                                {points}
                            </div>
                        </div>

                        <h2 className="text-2xl font-bold text-slate-700 mb-6 text-center flex items-center justify-center gap-2">
                            <ShoppingBag className="w-7 h-7 text-orange-500" />
                            ÁçéÂãµÂÖåÊèõÊâÄ
                        </h2>

                        <div className="grid grid-cols-2 gap-4 mb-8">
                            {REWARDS.map(item => {
                                const isOwned = inventory.includes(item.id);
                                const canBuy = points >= item.cost;
                                
                                return (
                                    <div key={item.id} className={`bg-white p-4 rounded-3xl border-4 ${isOwned ? 'border-sky-200 bg-sky-50' : 'border-slate-100'} flex flex-col items-center shadow-sm relative overflow-hidden group transition-all`}>
                                        {isOwned && <div className="absolute top-3 right-3 bg-sky-400 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">OWNED</div>}
                                        
                                        <div className="w-20 h-20 mb-3 mt-2 transition-transform group-hover:scale-110 duration-300 drop-shadow-sm">
                                            {item.icon}
                                        </div>
                                        <div className="font-bold text-slate-700">{item.name}</div>
                                        <div className="text-xs text-slate-400 mb-4">{item.desc}</div>
                                        
                                        {!isOwned ? (
                                            <button 
                                                onClick={() => buyReward(item)}
                                                disabled={!canBuy}
                                                className={`w-full py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-1 transition-all ${canBuy ? 'bg-yellow-400 hover:bg-yellow-500 text-yellow-900 shadow-[0_2px_0_rgb(202,138,4)] active:translate-y-0.5 active:shadow-none' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                            >
                                                {item.cost} <Coins className="w-3 h-3" />
                                            </button>
                                        ) : (
                                            <div className="text-sky-500 font-bold text-sm mt-auto py-2 flex items-center gap-1">
                                                <Check className="w-4 h-4" /> Â∑≤Êî∂Ëóè
                                            </div>
                                        )}
                                    </div>
                                )
                            })}
                        </div>

                        <div className="bg-white p-6 rounded-[2rem] border-2 border-slate-100 shadow-sm">
                            <h3 className="text-lg font-bold text-slate-600 mb-4 text-center flex items-center justify-center gap-2">
                                <Sparkles className="w-5 h-5 text-purple-400" />
                                ÊàëÁöÑÊî∂ËóèÊ´É ({inventory.length})
                            </h3>
                            <div className="flex flex-wrap gap-3 justify-center min-h-[80px]">
                                {inventory.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center text-slate-300 py-2">
                                        <div className="text-4xl mb-2">üì¶</div>
                                        <p className="text-sm">Á©∫Á©∫ÁöÑ...Âø´ÂéªÁ≠îÈ°åË≥∫ P Âπ£ÔºÅ</p>
                                    </div>
                                ) : (
                                    inventory.map(id => {
                                        const item = REWARDS.find(r => r.id === id);
                                        return (
                                            <div key={id} className="w-16 h-16 bg-slate-50 rounded-2xl p-2 border-2 border-slate-200 tooltip-trigger relative group cursor-help" title={item.name}>
                                                {item.icon}
                                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-slate-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                                                    {item.name}
                                                </div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}